---
layout: post
title: etc06
sitemap: false
hide_last_modified: true
---
# Nginx

* toc
{:toc .large-only}

# Nginx란?

Nginx란 `웹서버`의 일종이다. 웹서버는 클라이언트의 요청을 받아 정적파일을 사용자에게 응답해주는 역할을 한다. 반대의 개념으로 DB와 상호작용하며 클라이언트 요청에 따라 동적으로 결과를 생성해서 응답하는 `애플리케이션 서버(WAS)`가 있다.

Nginx는 웹서버 외에도 다양한 기능을 제공하고 있다.

## 특징
### 비동기 이벤트 기반 구조
스레드 기반이 아닌 비동기 기반으로 많은 요청을 동시에 처리 할 수 있어 트래픽이 몰리는 상황에서도 응답 시간을 일정하게 가져갈 수 있다.
또한, 스레드로 인한 장애나 오류 발생 가능성도 낮은 편이다.

### 리버스 프록시

![](/assets/img/etc/reverseproxy.png)

`리버스 프록시`란 클라이언트와 서버 간 응답, 요청을 중계해주는 중간 서버이다.  
한마디로 Nginx가 클라이언트의 모든 요청을 관리해주는 `단일 진입점`이 되는 셈이다.  

리버스 프록시는 아래와 같은 순서로 요청을 처리하게 된다.
1. 클라이언트가 도메인으로 서비스 접속
2. Nginx가 이를 먼저 받아서 요청 분석
3. 요청에 맞는 서버 및 포트 매핑
4. 서버에 요청을 전달하고, 응답을 먼저 받아 클라이언트에 최종 전달

우리가 실제 웹서비스를 이용 할 때 포트번호를 따로 안써도 되는 이유가 이러한 `리버스 프록시` 기능 덕분이다.
클라이언트는 Nginx까지만 접속이 가능하므로 서버 측에서는 실제 IP나 포트를 숨길 수 있어서 보안이 향상된다.  

여담으로 `nslookup`으로 검색했을 때 나오는 IP주소 또한 리버스 프록시 서버의 IP이다.

#### 로드밸런싱
리버스 프록시의 하위 기능 중 하나로써, 클라이언트 요청을 여러 서버에 균등하게 분배해주는 역할을 한다.리버스 프록시로 기능 별로 서버를 나눠주면, 로드밸런서가 `같은 기능을 수행하는 여러 서버에 요청을 분산`하여 처리해준다.

1. 클라이언트가 /api 요청 → Nginx가 요청을 분석.
2. /api 요청은 API 서버 그룹으로 전달.
3. API 서버 그룹 내에서 요청을 로드 밸런싱 → 서버 1, 서버 2, 서버 3 중 하나가 처리.

### 캐싱
자주 요청되는 데이터를 캐싱해서 클라이언트가 동일한 요청을 보낼 떄 처리 시간을 단축한다.
옵션에 따라 특정 경로나 파일만 캐싱하거나, HTTP 상태 코드에 따라 캐싱 여부를 결정 할 수도 있다.

### SSL/TLS지원
- SSL: 웹사이트와 브라우저 사이에 전송되는 데이터를 암호화하여 인터넷 연결을 보호하기 위한 계층
- TLS: SSL의 개선 버전으로, 클라이언트와 서버 간 데이터를 더 안전하고 효율적으로 암호화하는 기술

SSL/TLS는 클라이언트와 서버 간 통신을 암호화하여 데이터를 중간에 탈취하거나 변조되는 것을 방지하는 기술이다.  
SSL 인증서를 발급받아서 서버에 인증서 경로를 지정해주면 Http대신 Https로 통신이 일어난다.
Nginx가 SSL/TLS를 지원해준다는 것은 쉽게말해 `Https통신을 지원해준다`는 뜻이다.

## 사용사례

1. MSA
- 단일 진입점을 통해 클라이언트 요청을 적절한 마이크로서비스로 라우팅
- 로드밸런싱 기능으로 요청을 균등하게 분배하여 성능 최적화

2. 프론트엔드 서버와 백엔드 서버 연결
- 프론트엔드 서버에서 발생한 API 요청을 백엔드로 전달하고, 그 반환값을 다시 프론트엔드 서버로 전달
  
```nginx
server {
    listen 80;  # HTTP 요청 처리
    server_name example.com;  # 도메인 이름

    # 1. 정적 파일 요청 처리 (프론트엔드 서버)
    location / {
        root /var/www/frontend;  # 프론트엔드 빌드 파일 경로 (React, Vue 등)
        index index.html;
        try_files $uri /index.html;  # SPA 처리 (라우팅 지원)
    }

    # 2. API 요청 처리 (백엔드 서버)
    location /api/ {
        proxy_pass http://localhost:8080;  # 백엔드 서버 주소
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

- `/api/` 경로로 요청된 내용이 백엔드 서버로 전달됨
- 백엔드가 처리해서 데이터 반환
- 프론트엔드에서 데이터를 수신해서 화면에 렌더링

3. 무중단 배포
- 백엔드 서버 상태를 모니터링해서 정상 서버로만 요청을 전달
- 기존 연결을 끊지 않고 점진적으로 새로운 서버로 전환

## References
[그림으로 쉽게 보는 HTTPS, SSL, TLS - swimjiy](https://brunch.co.kr/@swimjiy/47)
